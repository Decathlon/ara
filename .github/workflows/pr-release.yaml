name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/dev/**'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Prepare
        id: prep
        run: |
          DEV_VERSION=$(cat charts/dev/Chart.yaml | grep version | sed -e 's/version: //')
          VERSION=$(echo "$DEV_VERSION" | sed -e 's/-rc.*//')
          echo ::set-output name=version::${VERSION}
          echo ::set-output name=rc::${DEV_VERSION}
      - name: Create PR with changes
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.CR_TOKEN }}
          commit-message: "chore: Release Charts stable ${{ steps.prep.outputs.version }}"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          branch: "helm/stable/${{ steps.prep.outputs.version }}"
          body: "Auto-release stable from ${{ steps.prep.outputs.rc }}"
          delete-branch: true
          title: "chore: Release Charts stable ${{ steps.prep.outputs.version }}"
